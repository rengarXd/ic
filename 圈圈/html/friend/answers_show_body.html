<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>问答详情body</title>
		<link rel="stylesheet" type="text/css" href="../../css/aui.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/fonts/iconfont.css"/>
		<!--<link rel="stylesheet" href="../../css/tools/loading.css" />-->
		<style>
			.img-cont img {
				max-width: 45px;
				height: 45px;
				line-height: 45px;
				border-radius: 50%;
				margin-right: 11px;
			}
			.aui-content-title {
				background: #fff;
				padding: 15px;
				font-size: 18px;
			}
			.aui-list-view:after {
				border: 0
			}
			.aui-img {
				width: 100%
			}
			.aui-col-xs-3 {
				padding-right: 5px;
			}
			.aui-col-xs-3 img {
				height: 80px !important;
			}
			.aui-col-xs-6 {
				padding-right: 5px;
			}
			.aui-ellipsis-1 {
				white-space: inherit;
			}
			#answers_body img {
				width: 35px !important;
				height: 35px !important
			}
			.noaskicon {
				font-size: 40px;
				color: #ddd;
				line-height: 40px;
			}
			#answer_headico {
				width: 45px !important;
				height: 45px !important
			}
			.loading {
				text-align: center;
				padding: 15px;
				color: #ADB2BB;
			}
			img #loading {
				width: 100%;
				background: url('../../image/friend/firend_nopic.png') no-repeat center center;
				background-color: rgb(0, 0, 0);
			}
			.ic_cnsj {
				position: absolute;
				top: 0;
				/* line-height: 36px; */
				width: 100%;
				left: 0;
				padding: 0 15px;
				color: #66A75A;
				line-height: 40px;
			}
			.ic_cn {
				float: right;
				color: #B4B4B4 !important;
				font-size: 14px;
				font-style: normal;
				background: #F3F3F3;
				border: 1px solid #ddd;
			}
			.ic_cn span {
				color: #BEBDBD !important;
				font-size: 12px !important;
			}
			.ic_cn:active {
				background: #dddddd !important;
			}
			.aui-user-view-cell:active {
				background: #ffffff !important;
			}
		</style>
	</head>
	<body>
		<div class="aui-toast" id="loading" style="display: none">
			<div class="aui-toast-loading"></div>
			<div class="aui-toast-content">
				回复中
			</div>
		</div>
		<div class="aui-content">
			<ul class="aui-list-view">
				<li class="aui-list-view-cell" tapmode>
					<div class="img-cont"><img class="aui-pull-left" id="answer_headico" src="../../image/noavatar.gif" />
					</div>
					<div class="aui-img-body">
						<span id="answer_name">&nbsp;&nbsp;&nbsp;</span><b class="aui-pull-right" style=""><i class="iconfont icon-jifen" style="float: right;color: #009f3b;font-size: 14px;" id="point"></i></b>
						<p class='aui-ellipsis-1' id="answer_from">
							&nbsp;&nbsp;&nbsp;
						</p>
					</div>
					<p style="margin-top: 5px; margin-bottom: 5px;" id="answer_content">
						&nbsp;&nbsp;&nbsp;
					</p>
					<div class="aui-content" style="display: inline-block;" id="an_photo">
						<div id="answers_img_data_body"></div>
					</div>
					<h6><span id="answer_time"></span>&nbsp;&nbsp;&nbsp;<span style="float: right" id="answer_askcount"></span></h6>
				</li>
			</ul>
		</div>
		<script type="text/html" id="answers_img_data">
			{{# for (var i = 0, len = d.imgs.length; i < len; i++) { }}
			<div class="aui-col-xs-3"><img src="../../image/friend/firend_nopic.png" data-echo="http://122.114.90.191/{{ d.imgs[i].im }}" class="aui-img" id="loading" />
			</div>
			{{# } }}
		</script>
		<div class="aui-content" style="display: none;" id="noask">
			<ul class="aui-list-view">
				<li class="aui-list-view-cell">
					<div>
						<center>
							<span class="iconfont icon-shafa noaskicon"></span>
							<br />
							<span style="font-size: 12px;
							color: #ddd;
							line-height: 26px;">快来回答问题吧</span>
						</center>
					</div>
				</li>
			</ul>
		</div>
		<div class="aui-content" style="padding-bottom: 55px;margin-bottom: 0;">
			<div>
				<ul class="aui-user-view aui-in" id="answers_body"></ul>
			</div>
			<li id="buttonload">
				<div class="loading" style="display: none">
					正在加载....
				</div>
			</li>
		</div>
		<script type="text/html" id="answers_data">
			{{# for (var i = 0, len = d.bbs_ask.length; i < len; i++) { }}
			{{# if(d.bbs_ask[i].isright==1){ }}
			<li class="aui-user-view-cell aui-img" style="background: #f3ffec">
			<div class="ic_cnsj">
			<img style="width: 40px !important;" src="../../image/friend/ic_ask_daan.png" /> <span class="aui-pull-right">提问者采纳</span><!--<span class="aui-pull-right">采纳日期：{{ d.bbs_ask[i].righttime }}</span>-->
			</div>
			<div style="margin-top: 34px;">
			<img class="aui-img-object aui-pull-left" src="http://122.114.90.191/{{ d.bbs_ask[i].head_ico }}">
			<div class="aui-img-body">
			<span>{{ d.bbs_ask[i].username }}<em>{{ H.$com.jsDateDiff(d.bbs_ask[i].time) }}</em></span>
			<p class='aui-ellipsis-1'>
			{{ d.bbs_ask[i].content }}
			</p>
			</div>
			</div>
			</li>
			{{# }else{ }}
			<li class="aui-user-view-cell aui-img">
			<img class="aui-img-object aui-pull-left" src="http://122.114.90.191/{{ d.bbs_ask[i].head_ico }}">
			<div class="aui-img-body">
			<span>{{ d.bbs_ask[i].username }}<em>{{ H.$com.jsDateDiff(d.bbs_ask[i].time) }}</em></span>
			<p class='aui-ellipsis-1'>
			{{ d.bbs_ask[i].content }}
			</p>
			<i class="aui-badge ic_cn" tapmode onclick="ic_cn({{ d.bbs_ask[i].id }});"><span class="iconfont icon-z077"></span> 采纳</i>
			</div>
			</li>
			{{# } }}
			{{# } }}
		</script>
	</body>
	<script type="text/javascript" src="../../script/AHelper.js"></script>
	<script type="text/javascript" src="../../script/zepto.min.js"></script>
	<script type="text/javascript" src="../../script/laytpl.js"></script>
	<script type="text/javascript" src="../../script/echo.min.js"></script>
	<script>
		var photoBrowser = null, answers = null, bbs = null, page = 1, loadLock = false;
		var ishaveright, userid;
		Zepto(function() {
			$("#an_photo").on("click", function() {
				//记录路径
				var photoBrowserPath = [];
				var imgs = $("#an_photo img");
				for (var i = 0; i < imgs.length; i++) {
					photoBrowserPath.push(imgs[i].src);
				}
				photoBrowser.open({
					images : photoBrowserPath,
					activeIndex : 0,
					bgColor : '#000'
				}, function(ret) {
					//					alert(JSON.stringify(ret));
					//如果单击则退出浏览
					if (ret.eventType == "click") {
						photoBrowser.close();
					}
				});
			});
		});
		function ic_cn(id) {
			api.confirm({
				title : '提示',
				msg : '确定要采纳此答案吗？',
				buttons : ['确定', '取消']
			}, function(ret, err) {
				if (ret) {
					if (ret.buttonIndex == 1) {
						api.ajax({
							url : window.serverUrl + '/ask_isright/user_id/' + answers.id + '/token/' + answers.token + '/ask_id/' + id + '/isright/1',
							cache : false
						}, function(ret, err) {
							if (ret && ret.retCode == 1) {
								api.toast({
									msg : '采纳此答案成功！'
								});
								location.reload();
							}
						});
					} else {
					}
				} else {
					//alert(JSON.stringify(err));
				}
			});
		}

		//1、获取数据 isshow为false则不显示  评论page 页数
		function get_data(isshow, isbutton) {
			loadLock = true;
			//1.2 接收要获取的问答ID
			bbs = H.$getPageParam();
			api.getPrefs({
				key : 'userinfo'
			}, function(ret, err) {
				// 1.3 获取用户信息对象
				answers = eval('(' + ret.value + ')');
				//1.4 如果是回复则不显示这个阻塞
				if (isshow) {
					api.showProgress({
						title : "正在加载"
					});
				}
				// 1.5 请求问答数据【新增分页】
				api.ajax({
					url : window.serverUrl + '/ask_list/token/' + answers.token + '/bbsid/' + bbs.id + '/page/' + page
				}, function(ret, err) {
					//1.4 如果是回复则不显示这个阻塞
					if (isshow) {
						api.hideProgress();
					}
					if (ret && ret.retCode == 1) {
						// 1.5 如果是回复则不再渲染(只渲染一次，优化加载)
						if (isshow) {
							$("#answer_headico").attr('src', window.serverUrlPath + ret.retValue.bbscontent[0].head_ico);
							$("#answer_name").html(ret.retValue.bbscontent[0].username);
							$("#answer_from").html("来自：" + ret.retValue.bbscontent[0].comedevice);
							$("#answer_content").html(ret.retValue.bbscontent[0].content);
							$("#answer_time").html(H.$com.jsDateDiff(ret.retValue.bbscontent[0].time));
							$("#answer_askcount").html("回复(" + ret.retValue.bbscontent[0].askcount + ")");
							$("#point").text(ret.retValue.bbscontent[0].point);
							ishaveright = ret.retValue.bbscontent[0].ishaveright;
							userid = ret.retValue.bbscontent[0].id;
							//图片渲染
							if (ret.retValue.bbscontent[0].imgs.length > 0) {
								var tpl = document.getElementById('answers_img_data').innerHTML;
								laytpl(tpl).render(ret.retValue.bbscontent[0], function(render) {
									document.getElementById('answers_img_data_body').innerHTML = render;
									echo.init({
										offset : 0,
										throttle : 150,
									});
								});
							} else {
								$("#an_photo").hide();
							}
						}
						if (ret.retValue.bbs_ask.length < 1 && page <= 1) {
							$("#noask").show();
							$(".loading").hide();
						} else {
							if (ret.retValue.count == page) {
								loadLock = true;
							} else {
								page++;
								loadLock = false;
							}
							// 1.7 如果是回复滚动到网页底部
							if (!isshow && isbutton) {
								location.reload();
							}
							// 1.8 如果是底部加载
							if (page >= 2) {
								var tpl = document.getElementById('answers_data').innerHTML;
								laytpl(tpl).render(ret.retValue, function(render) {
									$('#answers_body').append(render);
									if (ishaveright == 1) {
										$('.ic_cn').hide();
									}
									if (userid != answers.id) {
										$('.ic_cn').hide();
									}
									$(".loading").hide();
									//H.$com.scrollToDocButton();
								});
							} else {
								var tpl = document.getElementById('answers_data').innerHTML;
								laytpl(tpl).render(ret.retValue, function(render) {
									document.getElementById('answers_body').innerHTML = render;
									if (ishaveright == 1) {
										$('.ic_cn').hide();
									}
									if (userid != answers.id) {
										$('.ic_cn').hide();
									}
									$(".loading").hide();
									$("#noask").hide();
								});
							}
						}
						//alert();
					} else {
						api.toast({
							msg : err.body,
							location : 'center'
						});
					}
				});
			});
		}

		//2、获取更多的分页数据
		H.ready(function() {
			get_data(true, true);
			photoBrowser = api.require('photoBrowser');
			//6 回复框
			var inputField = api.require('inputField');
			inputField.open({
				bgColor : '#e5e5e5',
				lineColor : '#DDDDDD',
				fileBgColor : '#fcfcfc',
				borderColor : '#ffffff',
				sendImg : 'widget://res/ask/sendimg.png',
				maxLines : 3,
				fixedOn : api.frameName
			}, function(ret) {
				if (H.$com.trim(ret.msg)) {
					inputField.resignFirstResponder();
					H.$api.css(H.$api.byId("loading"), "display:block");
					api.ajax({
						url : window.serverUrl + '/ask_add/token/' + answers.token + '/user_id/' + answers.id + '/bbsid/' + bbs.id,
						cache : false,
						data : {
							values : {
								content : ret.msg,
								fromdevice : api.deviceModel
							}
						}
					}, function(ret, err) {
						H.$api.css(H.$api.byId("loading"), "display:none");
						if (ret && ret.retCode == 1) {
							api.toast({
								msg : ret.retDesc,
							});
							get_data(false, true);
						} else if (ret && ret.retCode == 0) {
							api.toast({
								msg : ret.retDesc,
							});
						} else {
							api.toast({
								msg : err.body,
								location : 'center'
							});
						}
					});
				} else {
					api.toast({
						msg : "总得说点什么吧"
					});
				}
			});
			inputField.setPlaceholder({
				placeholder : '相信你的回复可以一针见血'
			});
			//7 滚动到底部
			H.$scrolltobottom(function(ret, err) {
				$(".loading").show();
				if (loadLock == false) {
					get_data(false, false);
				} else {
					$(".loading").hide();
				}
				//8 滚动底部重新加载
			});
		});
	</script>
</html>