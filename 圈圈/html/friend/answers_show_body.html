<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>问答详情body</title>
		<link rel="stylesheet" type="text/css" href="../../css/aui.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/fonts/iconfont.css"/>
		<style>
			.img-cont img {
				max-width: 45px;
				height: 45px;
				line-height: 45px;
				border-radius: 50%;
				margin-right: 11px;
			}
			.aui-content-title {
				background: #fff;
				padding: 15px;
				font-size: 18px;
			}
			.aui-list-view:after {
				border: 0
			}
			.aui-img {
				width: 100%
			}
			.aui-col-xs-3 {
				padding-right: 5px;
			}
			.aui-col-xs-3 img{
				height:80px !important;
			}
			.aui-col-xs-6 {
				padding-right: 5px;
			}
			.aui-ellipsis-1 {
				white-space: inherit;
			}
			#answers_body img {
				width: 35px !important;
				height: 35px !important
			}
			.noaskicon {
				font-size: 40px;
				color: #ddd;
				line-height: 40px;
			}
			#answer_headico {
				width: 45px !important;
				height: 45px !important
			}
			.loading {
				text-align: center;
				padding: 15px;
				color: #ADB2BB;
			}
		</style>
	</head>
	<body>
		<div class="aui-toast" id="loading" style="display: none">
			<div class="aui-toast-loading"></div>
			<div class="aui-toast-content">
				回复中
			</div>
		</div>
		<div class="aui-content">
			<ul class="aui-list-view">
				<li class="aui-list-view-cell" tapmode>
					<div class="img-cont"><img class="aui-pull-left" id="answer_headico" src="../../image/noavatar.gif" />
					</div>
					<div class="aui-img-body">
						<span id="answer_name">&nbsp;&nbsp;&nbsp;</span><b class="aui-pull-right" style="">#楼主</b>
						<p class='aui-ellipsis-1' id="answer_from">
							&nbsp;&nbsp;&nbsp;
						</p>
					</div>
					<p style="margin-top: 5px; margin-bottom: 5px;" id="answer_content">
						&nbsp;&nbsp;&nbsp;
					</p>
					<div class="aui-content" style="display: inline-block;" id="an_photo">
						<div id="answers_img_data_body"></div>
					</div>
					<h6><span id="answer_time"></span>&nbsp;&nbsp;&nbsp;<span style="float: right" id="answer_askcount"></span></h6>
				</li>
			</ul>
		</div>
		<script type="text/html" id="answers_img_data">
			{{# for (var i = 0, len = d.imgs.length; i < len; i++) { }}
			<div class="aui-col-xs-3"><img src="http://q.endzk.com/{{ d.imgs[i].im }}" alt="" class="aui-img" />
			</div>
			{{# } }}
		</script>
		<div class="aui-content" style="display: none;" id="noask">
			<ul class="aui-list-view">
				<li class="aui-list-view-cell">
					<div>
						<center>
							<span class="iconfont icon-shafa noaskicon"></span>
							<br />
							<span style="font-size: 12px;
							color: #ddd;
							line-height: 26px;">沙发等你来坐</span>
						</center>
					</div>
				</li>
			</ul>
		</div>
		<div class="aui-content" style="padding-bottom: 55px;margin-bottom: 0;">
			<ul class="aui-user-view aui-in" id="answers_body"></ul>
			<li id="buttonload">
				<div class="loading" style="display: none">
					正在加载....
				</div>
			</li>
		</div>
		<script type="text/html" id="answers_data">
			{{# for (var i = 0, len = d.bbs_ask.length; i < len; i++) { }}
			<li class="aui-user-view-cell aui-img">
			<img class="aui-img-object aui-pull-left" src="http://q.endzk.com/{{ d.bbs_ask[i].head_ico }}">
			<div class="aui-img-body">
			<span>{{ d.bbs_ask[i].username }}<em>{{ H.$com.jsDateDiff(d.bbs_ask[i].time) }}</em></span>
			<p class='aui-ellipsis-1'>
			{{ d.bbs_ask[i].content }}
			</p>
			</div>
			</li>
			{{# } }}
		</script>
		<div class="aui-content">
			<ul class="aui-list-text"></ul>
		</div>
	</body>
	<script type="text/javascript" src="../../script/AHelper.js"></script>
	<script type="text/javascript" src="../../script/zepto.min.js"></script>
	<script type="text/javascript" src="../../script/laytpl.js"></script>
	<script>
		var photoBrowser = null, answers = null, bbs = null, page = 1;
		Zepto(function() {
			$("#an_photo").on("tap", function() {
				//记录路径
				var photoBrowserPath = [];
				var imgs = $("#an_photo img");
				for (var i = 0; i < imgs.length; i++) {
					photoBrowserPath.push(imgs[i].src);
				}
				photoBrowser.open({
					images : photoBrowserPath,
					activeIndex : 0,
					bgColor : '#000'
				}, function(ret) {
					//					alert(JSON.stringify(ret));
					//如果单击则退出浏览
					if (ret.eventType == "click") {
						photoBrowser.close();
					}
				});
			});
		});
		//1、获取数据 isshow为false则不显示  评论page 页数
		function get_data(isshow, isbutton) {
			//1.2 接收要获取的问答ID
			bbs = H.$getPageParam();
			api.getPrefs({
				key : 'userinfo'
			}, function(ret, err) {
				// 1.3 获取用户信息对象
				answers = eval('(' + ret.value + ')');
				//1.4 如果是回复则不显示这个阻塞
				if (isshow) {
					api.showProgress({
						title : "正在加载"
					});
				}
				// 1.5 请求问答数据【新增分页】
				api.ajax({
					url : window.serverUrl + '/ask_list/token/' + answers.token + '/bbsid/' + bbs.id + '/page/' + page
				}, function(ret, err) {
					//1.4 如果是回复则不显示这个阻塞
					if (isshow) {
						api.hideProgress();
					}
					if (ret && ret.retCode == 1) {
						// 1.5 如果是回复则不再渲染(只渲染一次，优化加载)
						if (isshow) {
							$("#answer_headico").attr('src', window.serverUrlPath + ret.retValue.bbscontent[0].head_ico);
							$("#answer_name").html(ret.retValue.bbscontent[0].username);
							$("#answer_from").html("来自：" + ret.retValue.bbscontent[0].fromdevice);
							$("#answer_content").html(ret.retValue.bbscontent[0].content);
							$("#answer_time").html(H.$com.jsDateDiff(ret.retValue.bbscontent[0].time));
							$("#answer_askcount").html("回复(" + ret.retValue.bbscontent[0].askcount + ")");
							//图片渲染
							if (ret.retValue.bbscontent[0].imgs.length > 0) {
								var tpl = document.getElementById('answers_img_data').innerHTML;
								laytpl(tpl).render(ret.retValue.bbscontent[0], function(render) {
									document.getElementById('answers_img_data_body').innerHTML = render;
								});
							}
						}
						if (ret.retValue.bbs_ask.length < 1 && page <= 1) {
							$("#noask").show();
						} else {
							// 1.6 对文档区域进行渲染
							if (ret.retValue.bbs_ask.length == 10) {
								//1.6.1 判断如果有第二页数据page+1
								page = page + 1;
							}
							$(".loading").hide();
							// 1.7 如果是回复滚动到网页底部
							if (!isshow && isbutton) {
								H.$com.scrollToDocButton();
							}
							// 1.8 如果是底部加载
							if (page >= 2) {
								var tpl = document.getElementById('answers_data').innerHTML;
								laytpl(tpl).render(ret.retValue, function(render) {
									$('#answers_body').append(render);
									//H.$com.scrollToDocButton();
								});
							} else {
								var tpl = document.getElementById('answers_data').innerHTML;
								laytpl(tpl).render(ret.retValue, function(render) {
									document.getElementById('answers_body').innerHTML = render;
								});
							}
						}
						//alert();
					} else {
						api.toast({
							msg : err.body,
							location : 'center'
						});
					}
				});
			});
		}

		//2、获取更多的分页数据
		H.ready(function() {
			get_data(true, true);
			photoBrowser = api.require('photoBrowser');
			//6 回复框
			var inputField = api.require('inputField');
			inputField.open({
				bgColor : '#e5e5e5',
				lineColor : '#DDDDDD',
				fileBgColor : '#fcfcfc',
				borderColor : '#ffffff',
				sendImg : 'widget://res/ask/sendimg.png',
				maxLines : 3,
				fixedOn : api.frameName
			}, function(ret) {
				if (H.$com.trim(ret.msg)) {
					inputField.resignFirstResponder();
					H.$api.css(H.$api.byId("loading"), "display:block");
					api.ajax({
						url : window.serverUrl + '/ask_add/token/' + answers.token + '/user_id/' + answers.id + '/bbsid/' + bbs.id,
						cache : false,
						data : {
							values : {
								content : ret.msg,
								fromdevice : api.deviceModel
							}
						}
					}, function(ret, err) {
						H.$api.css(H.$api.byId("loading"), "display:none");
						if (ret && ret.retCode == 1) {
							api.toast({
								msg : ret.retDesc,
							});
							get_data(false, true);
						} else if (ret && ret.retCode == 0) {
							api.toast({
								msg : ret.retDesc,
							});
						} else {
							api.toast({
								msg : err.body,
								location : 'center'
							});
						}
					});
				} else {
					api.toast({
						msg : "总得说点什么吧"
					});
				}
			});
			inputField.setPlaceholder({
				placeholder : '相信你的评论可以一针见血'
			});
			//7 滚动到底部
			H.$scrolltobottom(function(ret, err) {
				$(".loading").show();
				//8 滚动底部重新加载
				get_data(false, false);
			});
		});
	</script>
</html>