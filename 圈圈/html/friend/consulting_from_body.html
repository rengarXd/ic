<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>填写问诊信息body</title>
		<link rel="stylesheet" type="text/css" href="../../css/aui.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/fonts/iconfont.css"/>
		<style>
			.aui-arrow-right span {
				float: right;
				margin-right: 22px;
			}
			.wenzhen_btn_wen {
				color: #fff;
				position: fixed;
				bottom: 0;
				border-radius: 0;
				margin: 0;
				border: 0;
				z-index: 4;
				background: -webkit-gradient(linear, left top, left bottom, from(#ff7f27), to(#ff6001));
			}
			.wenzhen_btn_wen:active {
				background: -webkit-gradient(linear, left top, left bottom, from(#ff6001), to(#ff9001));
			}
			.aui-input-rows:first-child:after {
				border-top: 0
			}
			.aui-input-rows {
				display: block;
				padding: 0
			}
			#old_bgs {
				width: 100%;
				height: 100%;
				opacity: 0.4 !important;
				background: #000000;
				-moz-opacity: 0.4;
				position: absolute;
				z-index: 1;
			}
		</style>
	</head>
	<body>
		<div id="old_bgs" style="display:none"></div>
		<div class="aui-content">
			<ul class="aui-list-view">
				<li class="aui-list-view-cell" id="wenzhen">
					<a class="aui-arrow-right"> 问诊人 <span id="user_id"></span> </a>
				</li>
				<li class="aui-list-view-cell" id="chongwuleibie">
					<a class="aui-arrow-right"> 宠物类别 <span ></span id="pet_type"> </a>
				</li>
				<li class="aui-list-view-cell" id="chongwuxingbie">
					<a class="aui-arrow-right"> 宠物性别 <span id="pet_sex"></span> </a>
				</li>
				<li class="aui-list-view-cell" id="chongwunianling">
					<a class="aui-arrow-right"> 宠物年龄 <span id="pet_age"></span> </a>
				</li>
				<li class="aui-list-view-cell" id="yimiao">
					<a class="aui-arrow-right"> 是否打疫苗 <span id="yimiao_name"></span> </a>
				</li>
			</ul>
		</div>
		<!--症状描述-->
		<div class="aui-form">
			<div class="aui-input-row aui-input-rows">
				<textarea class="aui-input" id="pet_text" placeholder="请给您的宠物的症状做一个详细的描述" style="height: 140px;"></textarea>
			</div>
		</div>
		<!--症状描述-->
		<!--添加图片-->
		<div class="aui-content" style="margin-bottom: 68px;">
			<ul class="aui-list-view aui-grid-view" id="imgslist">
				<li class="aui-list-view-cell aui-img aui-col-xs-4" id="addpic">
					<img class="aui-img-object" src="../../image/add.jpg">
				</li>
			</ul>
		</div>
		<!--添加图片-->
		<!--撑开下部层页面-->
		<div style="height:10px;"></div>
		<!--撑开下部层页面-->
		<!--我要问诊-->
		<div class="aui-btn aui-btn-block wenzhen_btn_wen" id="consulting">
			我要问诊
		</div>
		<!--我要问诊-->
	</body>
	<script type="text/javascript" src="../../script/api.js"></script>
	<script type="text/javascript" src="../../script/AHelper.js"></script>
	<script type="text/javascript" src="../../script/zepto.min.js"></script>
	<script type="text/javascript" src="../../script/hammer.min.js"></script>
	<script type="text/javascript">
		var uiMediaScanner = null, imageFilter = null, imageBrowser = null, bMap = null, retobj = null;
		var temps_html = "";
		function exec(){
			api.getPrefs({
	            key:'pet_type'
            },function(ret,err){
            		$("#pet_type").html(ret.value);
            });
		}
		//			生成随机文件名
		function NewGuid() {
			function S4() {
				return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
			}

			return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
		}

		//				获取当前时间
		function getNowFormatDate() {
			var date = new Date();
			var seperator1 = "-";
			var year = date.getFullYear();
			var month = date.getMonth() + 1;
			var strDate = date.getDate();
			if (month >= 1 && month <= 9) {
				month = "0" + month;
			}
			if (strDate >= 0 && strDate <= 9) {
				strDate = "0" + strDate;
			}
			var currentdate = year + seperator1 + month + seperator1 + strDate
			return currentdate;
		}

		// 获取文件拓展名
		function getExt(fileName) {
			return fileName.substring(fileName.lastIndexOf('.') + 1);
		}

		// 图片压缩
		// imgsrc：源图片的路径
		// quality：图片压缩质量，一般建议0.5
		// scale：图片压缩比例，也是建议0.5
		// ext：源图片拓展名
		// callback：转换成功之后回调函数
		function imgCompress(imgsrc, quality, scale, ext, callback) {
			// 压缩文件的保存目录
			var savePath = api.cacheDir + "/" + getNowFormatDate() + "/";
			// 压缩文件生成的随机文件名称
			var savename = NewGuid() + "." + ext;
			imageFilter.compress({
				img : imgsrc,
				quality : quality,
				scale : quality,
				save : {
					album : false,
					imgPath : savePath,
					imgName : savename
				}
			}, function(ret, err) {
				if (ret) {
					callback(savePath + savename);
				} else {
					alert(JSON.stringify(err));
				}
			});
		}

		//		打开图片预览
		function openImageBrowser(imgs) {
			imageBrowser.openImages({
				imageUrls : imgs,
				showList : false,
				activeIndex : 0
			});
		}

		//			添加长按方法
		function addPress(obj, index) {
			// 获取目前长按的对象
			var hammertime = new Hammer(obj[0]);
			// 绑定长按对象
			hammertime.on("press", function(e) {
				api.confirm({
					title : '温馨提示',
					msg : '您确定要删除该图片吗？',
					buttons : ['确定', '取消']
				}, function(ret, err) {
					if (ret.buttonIndex == 1) {
						// 移除自己
						$(obj).remove();
						api.toast({
							msg : '删除成功！'
						});
					}
				});
			});
		}

		// 上传图片
		// url：上传的url地址
		// data：上传的文件
		// callback：上传成功返回地址
		function uploadFile(url, data, callback) {
			api.ajax({
				url : url,
				method : 'post',
				timeout : 30,
				dataType : 'json',
				returnAll : false,
				data : {
					files : {
						"goods" : data
					}
				}
			}, function(ret, err) {
				if (ret) {
					if (ret.retCode == 1) {
						callback(ret.retValue);
					} else if (ret.retCode == 0) {
						alert("上传失败");
					}
				} else {
					api.alert({
						msg : ('错误码：' + err.code + '；错误信息：' + err.msg + '；网络状态码：' + err.statusCode)
					});
				}
			});
		}

		Zepto(function($) {
			//			问诊
			$("#wenzhen").on("tap", function() {
				api.actionSheet({
					title : '请选择您要问诊的宠物名字',
					cancelTitle : '取消',
					buttons : ['可可']
				}, function(ret, err) {
					if (ret) {
						if (ret.buttonIndex == 1) {
							$("#user_id").html("可可");
						};
					} else {
						alert(JSON.stringify(err));
					}
				});
			});
			//			类别
			$("#chongwuxingbie").on("tap", function() {
				api.actionSheet({
					title : '请选择您要问诊的宠物性别',
					cancelTitle : '取消',
					buttons : ['雄', '雌']
				}, function(ret, err) {
					if (ret) {
						//						switch
						switch(ret.buttonIndex) {
							case 1:
								$("#pet_sex").html("雄");
								break;
							case 2:
								$("#pet_sex").html("雌");
								break;
						};
					} else {
						alert(JSON.stringify(err));
					}
				});
			});
			$("#chongwunianling").on("tap", function() {
				//
				$("#old_bgs").css("opacity", 0.4);
				$("#old_bgs").show();
				var UICustomPicker = api.require('UICustomPicker');
				UICustomPicker.open({
					rect : {
						x : (api.frameWidth - 220) / 2,
						y : (api.frameHeight - 340) / 2,
						w : 180,
						h : 340
					},
					styles : {
						bg : 'rgba(0,0,0,0)',
						normalColor : '#ffffff',
						selectedColor : '#ffffff',
						selectedSize : 36,
						tagColor : '#ffffff',
						tagSize : 36
					},
					data : [{
						tag : '年',
						scope : '0-20'
					}, {
						tag : '月',
						scope : '0-12'
					}],
					rows : 3,
					fixedOn : api.frameName,
					fixed : true
				}, function(ret, err) {
					if (ret) {
						if (ret.data) {
							var nian = ret.data[0];
							var yue = ret.data[1];
							$("#pet_age").html(nian + '年' + yue + '月');
							//
							$("#old_bgs").hide();
							UICustomPicker.close({
								id : ret.id
							});
						}
					} else {
						alert(JSON.stringify(err));
					}
				});
			});
			$("#yimiao").on("tap", function() {
				api.actionSheet({
					title : '是否打过疫苗',
					cancelTitle : '取消',
					buttons : ['是', '否']
				}, function(ret, err) {
					if (ret) {
						//						switch
						var index = ret.buttonIndex;
						switch(index) {
							case 1:
								$("#yimiao_name").html("是");
								break;
							case 2:
								$("#yimiao_name").html("否");
								break;
						};
					} else {
						alert(JSON.stringify(err));
					}
				});
			});
			// 获取图片宽高
			var normalW = $("#addpic img").width();
			// ###############################################################
			// 为图片添加点击预览功能,排除添加按钮
			$("#imgslist").on("tap", "li:not(#addpic)", function() {
				// 定义一个数组，存储需要预览的图片
				var browerImgs = [];
				$("#imgslist li:not(#addpic)").each(function() {
					// 将图片追加到数组中
					browerImgs.push($(this).find("img").attr("src"));
				});
				// 调用图片预览函数
				openImageBrowser(browerImgs);
			});
			$("#imgslist").on("tap", "#addpic", function() {
				api.actionSheet({
					title : '请选择图片来源',
					cancelTitle : '取消',
					buttons : ['拍照', '相册']
				}, function(ret, err) {
					var index = ret.buttonIndex;
					switch(index) {
						// 拍照
						case 1:
							// 打开拍照
							api.getPicture({
								sourceType : "camera",
								encodingType : "jpg",
								destinationType : "url",
								mediaValue : "pic",
								quality : 50,
								saveToPhotoAlbum : true
							}, function(ret, err) {
								if (ret && ret.data) {
									// 拍照返回的本地路径
									var returnUrl = ret.data;
									// 图片压缩
									imgCompress(returnUrl, 0.5, 0.5, getExt(returnUrl), function(compressImg) {
										var showImgHtml = '<li class="aui-list-view-cell aui-img aui-col-xs-4"><img class="aui-img-object" src="' + compressImg + '" style="width:' + normalW + 'px;height:' + normalW + 'px;"></li>';
										// 追加图片
										$("#addpic").before(showImgHtml);
										// ########################################  绑定长按事件 ########################
										addPress($("#imgslist img[src='" + compressImg + "']").parent("li"));
										// ########################################
										// ################### 上传图片 #########################
										uploadFile(window.serverUrl + '/img_upload/token/' + retobj.token + '/user_id/' + retobj.id, compressImg, function(serverImg) {
											alert("上传成功后服务器返回的地址：http://linshiren.gotoip3.com/" + serverImg);
										});
									});
								} else {
									api.toast({
										msg : '没有选择，或者选择出错'
									});
								}
							});
							break;
						// 打开图片选择器
						case 2:
							uiMediaScanner.open({
								type : 'picture',
								column : 4,
								classify : true,
								max : 6,
								sort : {
									key : 'time',
									order : 'desc'
								},
								texts : {
									stateText : '已选*项',
									cancelText : '取消',
									finishText : '完成'
								},
								styles : {
									bg : '#fff',
									mark : {
										icon : '',
										position : 'bottom_left',
										size : 20
									},
									nav : {
										bg : '#b23e4b',
										stateColor : '#fff',
										stateSize : 18,
										cancelBg : 'rgba(0,0,0,0)',
										cancelColor : '#fff',
										cancelSize : 18,
										finishBg : 'rgba(0,0,0,0)',
										finishColor : '#fff',
										finishSize : 18
									}
								}
							}, function(ret) {
								if (ret) {
									for (var i = 0; i < ret.list.length; i++) {
										var selectImg = ret.list[i];
										// 获取图片的路径c
										var selectimgPath = selectImg.path;
										var selectimgThumbPath = selectImg.thumbPath;
										// 图片压缩
										imgCompress(selectimgPath, 0.5, 0.5, selectImg.suffix, function(compressImg) {
											// 追加图片
											$("#addpic").before('<li class="aui-list-view-cell aui-img aui-col-xs-4"><img class="aui-img-object" src="' + compressImg + '" style="width:' + normalW + 'px;height:' + normalW + 'px;"></li>');
											// ########################################  绑定长按事件 ########################
											addPress($("#imgslist img[src='" + compressImg + "']").parent("li"));
											// ########################################
											// ################### 上传图片 #########################
											uploadFile(window.serverUrl + '/img_upload/token/' + retobj.token + '/user_id/' + retobj.id, compressImg, function(serverImg) {
												alert("上传成功后服务器返回的地址：http://linshiren.gotoip3.com/" + serverImg);
											});
										});
									}
								}
							});
							break;
					}
				});
			});
			$("#consulting").on("tap", function() {
				//				$("#wenzhenren").html();
				var wenzhenren = $("#user_id").html();
				if (wenzhenren) {
					var pet_sex = $("#pet_sex").html();
					if (pet_sex) {
						var pet_age = $("#pet_age").html();
						if (pet_age) {
							var yimiao_name = $("#yimiao_name").html();
							if (yimiao_name) {
								api.ajax({
									url : window.serverUrl + '/inquiry_add/token/' + retobj.token + '/user_id/' + retobj.id,
									method : 'post',
									data : {
										values : {
											
											"user_id" : user_id,
											"doctor_id": id,
											"pet_sex" : pet_sex,
											"pet_age" : pet_age,	
											"content": pet_text
										}
									}
								}, function(ret, err) {
									if (ret && ret.Code == 1) {
										H.$openWin("chat_msg_head", "chat_msg_head.html");
									} else {
										api.alert({
											msg : ('错误码：' + err.code + '；错误信息：' + err.msg + '；网络状态码：' + err.statusCode)
										});
									}
								});
							} else { msg:'抱歉，您没有选择是否打过疫苗'
							};
						} else {
							api.toast({
								msg : '抱歉，您没有添加宠物年龄'
							});
						};
					} else {
						api.toast({
							msg : '抱歉，您没有添加宠物性别'
						});
					};
				} else {
					api.toast({
						msg : '抱歉，您没有添加问诊人'
					});
				}
				api.parseTapmode();
				//				H.$openWin("chat_msg_head", "chat_msg_head.html");
			});
		});
		H.ready(function() {
			api.getPrefs({
				key : 'userinfo'
			}, function(ret, err) {
				retobj = eval('(' + ret.value + ')');
			});
			// 引入多选模块
			uiMediaScanner = api.require('UIMediaScanner');
			// 引入过滤压缩模块
			imageFilter = api.require("imageFilter");
			// 引入图片浏览模块
			imageBrowser = api.require('imageBrowser');
			// 判断是否是IOS系统
			isIOS = api.systemType == "ios" ? true : false;
		});
	</script>
</html>