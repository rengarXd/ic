<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>订单详情body</title>
		<link rel="stylesheet" type="text/css" href="../../css/aui.css" />
		<link rel="stylesheet" type="text/css" href="../../css/fonts/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../../css/tools/loading.css"/>
		<style>
			.ic_zl_icon {
				display: block;
				font-size: 20px;
			}
			.q_address {
				font-size: 19px;
				/* font-weight: 800; */
				color: #1786FF !important;
			}
			.q_addressd {
				color: #1786FF;
				font-size: 15px;
			}
			.products_no {
				font-size: 12px !important;
				color: #bbb;
			}
			.ways {
				margin-right: 16px;
			}
			.aui-content {
				background: #fff;
			}
			.aui-nav .aui-bar-tab {
				background: #34495E;
			}
			.aui-nav .aui-bar-tab li .aui-iconfont, .aui-nav .aui-bar-tab li p {
				color: #fff;
			}
			.aui-nav .aui-bar-tab li.active .aui-iconfont, .aui-nav .aui-bar-tab li.active p {
				color: #14bd7c;
			}
			.aui-nav {
				background: #fff;
				font-size: 18px;
				color: #fff;
				text-align: center;
			}
			.aui-nav  div {
				height: 55px;
			}
			.aui-nav .buy {
				line-height: 55px;
				background: -webkit-gradient(linear, left top, left bottom, from(#ff7f27), to(#ff6001));
			}
			.aui-nav .buy:active {
				line-height: 55px;
				background: -webkit-gradient(linear, left top, left bottom, from(#e06816), to(#f07927));
			}
			.ms_info {
				line-height: 55px;
			}
			.ms_font {
				font-size: 15px !important;
				color: #000000 !important;
			}
			.message_info {
				padding-left: 15px !important;
				font-size: 15px;
			}
			.ic_radio:checked {
				background-color: #ffffff !important;
				border: 1px solid #dddddd
			}
			.ic_shop_title {
				font-size: 12px;
				line-height: 17px !important;
				height: 52px !important;
				/* line-height: 13px; */
				overflow: hidden;
				width: 100%;
				display: block;
				padding-left: 8px;
				color: #000000;
			}
		</style>
	</head>
	<body>
		<div id="cart_html">
			<!--页面加载中-->
			<div style="text-align: center" id="ic_loading"><img src="../../image/loading.png" width="70" height="70" />
				<br />
				<span>加载中...</span>
			</div>
			<!--页面加载中-->
		</div>
		<!--撑开相应高度-->
		<div style="height: 55px;"></div>
		<!--撑开相应高度-->
		<footer class="aui-nav">
			<div class="aui-col-xs-8">
				<div class="aui-col-xs-5 ms_info">
					<p class="ms_font">
						共<span style="color: #fd0202;" id="goodsNum">*</span>件商品
					</p>
				</div>
				<div class="aui-col-xs-7 ms_info">
					<p class="ms_font">
						总价：￥<span style="color: #fd0202;" id="totalPrice">*</span>元
					</p>
				</div>
			</div>
			<div class="aui-col-xs-4 buy" onclick="post_data();">
				提交订单
			</div>
		</footer>
		<script type="text/html" id="cart_data">
			<div class="aui-content">
			<ul class="aui-list-view">
			{{# if ( d.retValue.address.length == 0 ) { }}
			<li class="aui-list-view-cell">
			<div class="q_addressd" onclick="add_page();" style="text-align: center;">
			<span class="iconfont icon-14052229 q_address"></span>&nbsp;&nbsp;新增地址
			</div>
			</li>
			{{# } else { }}
			<li class="aui-list-view-cell" onclick="openAddress();" >
			<div class="aui-arrow-right" style="margin: 8px 0 8px 0;">
			<div class="aui-col-xs-1">
			<span class="iconfont icon-dingweidizhigpsditu ic_zl_icon"></span>
			</div>
			<div class="aui-col-xs-11">
			<span style="float: left">收货人：<span id="shouhuoren">{{ d.retValue.address[0].accept_name }}</span></span>
			<span class="aui-pull-right" style="margin-right: 12px;" id="telephone">{{ d.retValue.address[0].mobile }}</span><br />
			<p style="margin-top: 5px;" >
			收货地址：<span id="addressInfo">{{ d.retValue.address[0].province_val }} {{ d.retValue.address[0].city_val }} {{ d.retValue.address[0].area_val }} {{ d.retValue.address[0].address }}；
			</span>
			</p>
			</div>
			</div>
			</li>
			{{# } }}
			{{# for(var a = 1, b = d.retValue.address.length; a < b; a++) { }}
			<li class="aui-list-view-cell address_list" style="display: none;">
			<div style="margin: 8px 0 8px 0;">
			<div class="aui-col-xs-2" >
			<input class="aui-radio" type="radio" name="demo1" onclick="closeAddress({{ a }});">
			</div>
			<div class="aui-col-xs-10">
			<span style="float: left" >收货人：{{ d.retValue.address[a].accept_name }}<span class="aui-pull-right" style="margin-right: 12px;" >{{ d.retValue.address[a].mobile}}</span>
			<p style="margin-top: 5px;" >
			收货地址：{{ d.retValue.address[a].province_val }} {{ d.retValue.address[a].city_val }} {{ d.retValue.address[a].area_val }} {{ d.retValue.address[a].address }}；
			</p> </span>
			</div>
			</div>
			</li>
			{{# } }}
			<li class="aui-list-view-cell address_list" style="display: none;">
			<div class="q_addressd" onclick="add_page();" style="text-align: center;">
			<span class="iconfont icon-14052229 q_address"></span>&nbsp;&nbsp;新增地址
			</div>
			</li>
			</ul>
			</div>
			<div class="aui-content">
			<ul class="aui-list-view">
			<li class="aui-list-view-cell">
			<span class="products_no">商品编号:{{ d.retValue.goodsList[0].goods_no }}</span>
			</li>
			<li class="aui-list-view-cell" style="background: #f4f4f4">
			<div class="aui-col-xs-3">
			<img src="http://122.114.90.191/{{ d.retValue.goodsList[0].img }}" style="height: 50px !important;"/>
			</div>
			<div class="aui-col-xs-9">
			<span class="ic_shop_title">{{ d.retValue.goodsList[0].name }}</span>
			</div>
			<div style="display: inline-block;width: 100%;">
			<div class="aui-col-xs-12">
			<span style="font-size: 12px;">
			{{# if (contents.content) { }}
			商品型号：{{ JSON.stringify(contents.content) }}
			{{# } }}
			</span>
			<br />
			<span style="color:#fd0202">￥{{ d.retValue.goodsList[0].sell_price }}
			<span class="aui-pull-right">x
			<span id="countNum">
			{{# if (contents.num){ }}
			{{ contents.num }}
			{{# }else{ }}
			{{ d.retValue.goodsList[0].count }}
			{{# } }}
			</span>
			</span>
			</span>
			</div>
			</div>
			</li>
			<li class="aui-list-view-cell">
			<div class="aui-col-xs-6">
			购买数量
			</div>
			<div class="aui-col-xs-6">
			<div class="aui-counter aui-danger aui-pull-right">
			<div class="aui-counter-minus aui-disabled" onclick="minus();"></div>
			<input class="aui-counter-input" type="number" id="member" name="memVal" value="1" onfocus="this.blur();">
			<div class="aui-counter-plus" onclick="plus();"></div>
			</div>
			</div>
			</li>
			<li class="aui-list-view-cell">
			<span>商家类别<span class="aui-pull-right">商城自营</span></span>
			</li>
			<li class="aui-list-view-cell" onclick="Distribution();">
			<span class="aui-arrow-right">配送方式
			<span style="color: #bbb !important; font-size: 11px !important;" id="yunfei"></span>
			<span class="aui-pull-right ways" id="delivery" deliveryVal="" ></span>
			</span>
			</li>
			<li class="aui-list-view-cell" onclick="payMent();">
			<a class="aui-arrow-right">支付方式<span class="aui-pull-right ways" id="payments" payment=""></span></a>
			</li>
			<li>
			<div class="aui-input-row">
			<span class="aui-input-addon message_info">买家留言：</span>
			<input type="text" class="aui-input" name="test" id="Message" placeholder="请输入您的留言"/>
			</div>
			</li>
			</ul>
			</div>
			<div class="aui-content">
			<ul class="aui-list-view">
			<li class="aui-list-view-cell" onclick="active_message();">
			<div class="aui-arrow-right" >
			活动信息<span class="aui-pull-right ways" id="activeMessage"></span>
			</div>
			</li>
			{{#if (d.retValue.prop.length == 0 ) { }}
			<li class="aui-list-view-cell">
			<span style="text-align: center;color: #bbb">暂无相关活动信息</span>
			</li>
			{{# } else { }}
			{{# for(var i = 0, len = d.retValue.prop.length; i < len; i++){ }}
			<li class="aui-list-view-cell active_list" style="display: none;">
			<div class="aui-col-xs-2">
			<input class="aui-radio" type="radio" name="activeCheck" onclick="closeActive({{ i }});">
			</div>
			<div class="aui-col-xs-10">
			<span>{{ d.retValue.prop[i].name }}</span><br />
			<span>代金卷编号{{ d.retValue.prop[i].card_name }}</span>
			<span class="aui-pull-right" >抵用金额：{{ d.retValue.prop[i].value }}</span>
			</div>
			</li>
			{{# } }}
			<li class="aui-list-view-cell active_list" style="display: none;">
			<div style="width: 100%" class="aui-btn aui-btn-warning aui-btn-outlined aui-pull-right" onclick="removeActive();">取消</div>
			</li>
			{{# } }}
			</ul>
			</div>
		</script>
	</body>
	<script type="text/javascript" src="../../script/AHelper.js"></script>
	<script type="text/javascript" src="../../script/zepto.min.js"></script>
	<script type="text/javascript" src="../../script/laytpl.js"></script>
	<script type="text/javascript">
		var retabc = null, contents = null, result = null, addressData = null, proId = null, ticket_ids = null, accept_name = null, province = null, city = null, area = null, address = null, telphone = null, totalPlus = null;
		Zepto(function($) {
		});
		//1、获取数据
		function get_data() {
			if (contents.productId) {
				//请求ajax数据
				api.ajax({
					url : window.serverUrl + '/cart2/token/' + retabc.token + '/type/product' + '/user_id/' + retabc.id + '/id/' + contents.productId,
				}, function(ret, err) {
					if (ret && ret.retCode == 1) {
						result = ret.retValue;
						//alert(JSON.stringify(result));
						if (contents.num) {
							totalPlus = parseInt(contents.num) * parseInt(result.goodsList[0].sell_price);
							$("#totalPrice").html(totalPlus);
							$("#goodsNum").text(contents.num);
						} else {
							$("#totalPrice").text(result.goodsList[0].sell_price);
							$("#goodsNum").text(result.goodsList[0].count);
						}
						if (result.address.length == 0) {
							api.toast({
								msg : '请先添加收货地址'
							});
						} else {
							accept_name = result.address[0].accept_name;
							province = result.address[0].province;
							city = result.address[0].city;
							area = result.address[0].area;
							address = result.address[0].address;
							mobile = result.address[0].mobile;
						}
						var t = document.getElementById('cart_data').innerHTML;
						laytpl(t).render(ret, function(render) {
							document.getElementById('cart_html').innerHTML = render;
							api.parseTapmode();
							if (contents.num) {
								$("#member").val(parseInt(contents.num));
							} else {
								$("#member").val(parseInt(1));
							}
						});
					} else {
						alert(JSON.stringify(err.msg));
					}
				});
			} else {
				//请求ajax数据
				api.ajax({
					url : window.serverUrl + '/cart2/token/' + retabc.token + '/type/goods' + '/user_id/' + retabc.id + '/id/' + contents.goodId,
				}, function(ret, err) {
					if (ret && ret.retCode == 1) {
						result = ret.retValue;
						//alert(JSON.stringify(result));
						if (contents.num) {
							totalPlus = parseInt(contents.num) * parseInt(result.goodsList[0].sell_price);
							$("#totalPrice").html(totalPlus);
							$("#goodsNum").text(contents.num);
						} else {
							$("#totalPrice").text(result.goodsList[0].sell_price);
							$("#goodsNum").text(result.goodsList[0].count);
						}
						if (result.address.length == 0) {
							api.toast({
								msg : '请先添加收货地址'
							});
						} else {
							accept_name = result.address[0].accept_name;
							province = result.address[0].province;
							city = result.address[0].city;
							area = result.address[0].area;
							address = result.address[0].address;
							mobile = result.address[0].mobile;
						}
						var t = document.getElementById('cart_data').innerHTML;
						laytpl(t).render(ret, function(render) {
							document.getElementById('cart_html').innerHTML = render;
							api.parseTapmode();
							if (contents.num) {
								$("#member").val(parseInt(contents.num));
							} else {
								$("#member").val(parseInt(1));
							}
						});
					} else {
						alert(JSON.stringify(err.msg));
					}
				});
			}
		}

		//2、打开地址选择
		function openAddress() {
			$(".address_list").toggle();
		}

		//2.1、关闭地址选择器并选择相应地址
		function closeAddress(a) {
			$(".address_list").hide();
			$("#shouhuoren").html(result.address[a].accept_name);
			$("#telephone").html(result.address[a].mobile);
			$("#addressInfo").html(result.address[a].province_val + result.address[a].city_val + result.address[a].area_val + result.address[a].address);
			accept_name = result.address[a].accept_name;
			province = result.address[a].province;
			city = result.address[a].city;
			area = result.address[a].area;
			address = result.address[a].address;
			mobile = result.address[a].mobile;
		}

		/*
		 处理商品数量加
		 * */
		function plus() {
			//4、处理数量加
			//4.1 获取最新数量
			var member = $("#member").val();
			//4.2 转整型
			var m = parseInt(member);
			//4.2 数量+1
			$("#member").val(m + 1);
			//4.3 判断数量
			if (m >= 1) {
				$(".aui-counter-minus").removeClass('aui-disabled');
			}
			$("#countNum").html(++member);
			$("#goodsNum").html(member);
			totalPlus = parseInt(member) * parseInt(result.goodsList[0].sell_price);
			$("#totalPrice").html(totalPlus);
		}

		/*处理数量减*/
		function minus() {
			//5.1 获取最新的数量
			var members = $("#member").val();
			//5.2 字符串转换为整型
			var ms = parseInt(members);
			if (ms < 2) {
				$(".aui-counter-minus").addClass('aui-disabled');
			} else {
				$("#member").val(ms - 1);
			}
			//4.3 判断数量
			if (ms < 1) {
				$(".aui-counter-minus").remove('minus();');
			}
			$("#countNum").html($("#member").val());
			$("#goodsNum").html($("#member").val());
			var minuend = result.goodsList[0].sell_price;
			if (members > 1) {
				var totalMinus = parseInt($("#totalPrice").html()) - parseInt(minuend);
				$("#totalPrice").html(totalMinus);
			} else {
				api.toast({
					msg : '商品数量最少为1件'
				});
			}
		}

		//选择配送方式
		function Distribution() {
			api.actionSheet({
				title : '配送方式（由第三方物流公司配送）',
				cancelTitle : '取消',
				buttons : ['快递', '货到付款']
			}, function(ret, err) {
				switch(ret.buttonIndex) {
					case 1:
						$("#delivery").attr("deliveryVal", 1);
						if (contents.productId) {
							api.ajax({
								url : window.serverUrl + '/order_delivery/token/' + retabc.token + '/user_id/' + retabc.id,
								data : {
									values : {
										//									"goodId[]" : contents.goodId,
										"productId[]" : contents.productId,
										"province" : result.address[0].province,
										"distribution" : $("#delivery").attr("deliveryVal"),
										"num" : $("#member").val()
									}
								}
							}, function(ret, err) {
								if (ret) {
									//                      		alert(JSON.stringify(ret));
									$("#delivery").html(ret.retValue.name);
									if (ret.retValue.if_delivery == 0) {
										$("#yunfei").html("运费：" + ret.retValue.price + "元");
										//									$("#totalPrice").text(parseInt($("#totalPrice").text()) + parseInt(ret.retValue.price));
									} else {
										alert("您所在的地区暂不支持配送，请联系客服人员");
									}
								} else {
									alert(JSON.stringify(err));
								}
							});
						} else {
							api.ajax({
								url : window.serverUrl + '/order_delivery/token/' + retabc.token + '/user_id/' + retabc.id,
								data : {
									values : {
										//									"goodId[]" : contents.goodId,
										"goodsId[]" : contents.goodId,
										"province" : result.address[0].province,
										"distribution" : $("#delivery").attr("deliveryVal"),
										"num" : $("#member").val()
									}
								}
							}, function(ret, err) {
								if (ret) {
									//                      		alert(JSON.stringify(ret));
									$("#delivery").html(ret.retValue.name);
									if (ret.retValue.if_delivery == 0) {
										$("#yunfei").html("运费：" + ret.retValue.price + "元");
										//									$("#totalPrice").text(parseInt($("#totalPrice").text()) + parseInt(ret.retValue.price));
									} else {
										alert("您所在的地区暂不支持配送，请联系客服人员");
									}
								} else {
									alert(JSON.stringify(err));
								}
							});
						};
						break;
					case 2:
						$("#delivery").attr("deliveryVal", 2);
						if (contents.productId) {
							api.ajax({
								url : window.serverUrl + '/order_delivery/token/' + retabc.token + '/user_id/' + retabc.id,
								data : {
									values : {
										"productId[]" : contents.productId,
										"province" : result.address[0].province,
										"distribution" : $("#delivery").attr("deliveryVal"),
										"num" : $("#member").val()
									}
								}
							}, function(ret, err) {
								if (ret) {
									//alert(JSON.stringify(ret));
									$("#delivery").html(ret.retValue.name);
									if (ret.retValue.if_delivery == 0) {
										$("#yunfei").html("运费：" + ret.retValue.price + "元");
										//									$("#totalPrice").text(parseInt($("#totalPrice").text()) + parseInt(ret.retValue.price));
									} else {
										alert("您所在的地区暂不支持配送，请联系客服人员");
									}
								} else {
									alert(JSON.stringify(err));
								}
							});
						} else {
							api.ajax({
								url : window.serverUrl + '/order_delivery/token/' + retabc.token + '/user_id/' + retabc.id,
								data : {
									values : {
										"goodsId[]" : contents.goodId,
										"province" : result.address[0].province,
										"distribution" : $("#delivery").attr("deliveryVal"),
										"num" : $("#member").val()
									}
								}
							}, function(ret, err) {
								if (ret) {
									//alert(JSON.stringify(ret));
									$("#delivery").html(ret.retValue.name);
									if (ret.retValue.if_delivery == 0) {
										$("#yunfei").html("运费：" + ret.retValue.price + "元");
										//									$("#totalPrice").text(parseInt($("#totalPrice").text()) + parseInt(ret.retValue.price));
									} else {
										alert("您所在的地区暂不支持配送，请联系客服人员");
									}
								} else {
									alert(JSON.stringify(err));
								}
							});
						}
						break;
				};
			});
		}

		//选择支付方式
		function payMent() {
			api.actionSheet({
				title : '请选择支付方式',
				cancelTitle : '取消',
				buttons : ['预存款', '在线支付']
			}, function(ret, err) {
				switch(ret.buttonIndex) {
					case 1:
						$("#payments").html("预存款");
						$("#payments").attr("payment", 1);
						break;
					case 2:
						$("#payments").html("在线支付");
						$("#payments").attr("payment", 11);
						break;
				};
			});
		}

		//活动信息选择器
		function active_message() {
			$("input[name='activeCheck']").removeClass('ic_radio');
			$(".active_list").toggle();
		}

		//隐藏并获取选中的活动信息
		function closeActive(i) {
			$("#activeMessage").text(result.prop[i].name);
			ticket_ids = result.prop[i].id;
			$(".active_list").hide();
		}

		//移除活动信息
		function removeActive() {
			//添加选择框移除样式
			$("input[name='activeCheck']").addClass('ic_radio');
			ticket_ids = 0;
			//移除所选活动名
			$("#activeMessage").text('');
		}

		//新增地址
		function add_page() {
			H.$openWin("user_shop_address_add_header", "../me/user_shop_address_add_header.html");
		}

		//提交订单
		function post_data() {
			if (result.prop.length !== 0) {
				ticket_ids = ticket_ids;
			} else {
				ticket_ids = 0;
			}
			var delivery_ids = $("#delivery").attr("deliveryVal");
			if (delivery_ids) {
				var pays = $("#payments").attr("payment");
				if (pays) {
					if (result.address.length != 0) {
						//判断信息是否为空的两种情况；
						var message = null;
						if ($("input[name='test']").val()) {
							message = $("input[name='test']").val();
						} else {
							message = 0;
						}
						api.showProgress({
							title : '订单提交中',
							text : '请稍后..',
							animationType : 'fade',
							modal : false
						});
						if (contents.productId) {
							//ajax提交生成货品订单
							api.ajax({
								url : window.serverUrl + '/cart3/direct_type/product' + '/user_id/' + retabc.id + '/token/' + retabc.token,
								method : 'post',
								data : {
									values : {
										"direct_gid" : contents.productId,
										"direct_num" : $("#goodsNum").text(),
										"accept_name" : accept_name,
										"province" : province,
										"city" : city,
										"area" : area,
										"address" : address,
										"mobile" : mobile,
										"delivery_id" : delivery_ids,
										"payment" : pays,
										"ticket_id" : ticket_ids,
										"Message" : message,
									}
								}
							}, function(ret, err) {
								if (ret) {
									var orders = ret.retValue;
									switch (ret.retCode) {
										case 0 :
											api.hideProgress();
											alert('请检查您提交过的订单信息，不要重复提交');
											break;
										case 1 :
											api.hideProgress();
											api.toast({
												msg : '免单订单生成成功'
											});
										case 2 :
											console.log(orders);
											api.hideProgress();
											H.$openWin("shop_order_creation_header", "shop_order_creation_header.html", orders);
									}
								} else {
									alert(JSON.stringify(err));
								}
							});
						} else {
							//ajax提交生成商品订单
							api.ajax({
								url : window.serverUrl + '/cart3/direct_type/goods' + '/user_id/' + retabc.id + '/token/' + retabc.token,
								method : 'post',
								data : {
									values : {
										"direct_gid" : contents.goodId,
										"direct_num" : $("#goodsNum").text(),
										"accept_name" : accept_name,
										"province" : province,
										"city" : city,
										"area" : area,
										"address" : address,
										"mobile" : mobile,
										"delivery_id" : delivery_ids,
										"payment" : pays,
										"ticket_id" : ticket_ids,
										"Message" : message,
									}
								}
							}, function(ret, err) {
								if (ret) {
									var orders = ret.retValue;
									switch (ret.retCode) {
										case 0 :
											api.hideProgress();
											alert('请检查您提交过的订单信息，不要重复提交');
											break;
										case 1 :
											api.hideProgress();
											api.toast({
												msg : '免单订单生成成功'
											});
										case 2 :
											console.log(orders);
											api.hideProgress();
											H.$openWin("shop_order_creation_header", "shop_order_creation_header.html", orders);
									}
								} else {
									alert(JSON.stringify(err));
								}
							});
						};
					} else {
						api.toast({
							msg : '请添加收货信息'
						});
					}
				} else {
					api.toast({
						msg : '请选择支付方式'
					});
				}
			} else {
				api.toast({
					msg : '请选择配送方式'
				});
			}
		}


		H.ready(function() {
			contents = H.$getPageParam();

			api.getPrefs({
				key : 'userinfo'
			}, function(ret, err) {
				retabc = eval("(" + ret.value + ")");
				get_data();
			});
			//监听地址改变
			api.addEventListener({
				name : 'addressChange'
			}, function(ret, err) {
				location.reload();
			});
		});
	</script>
</html>