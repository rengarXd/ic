<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title></title>
		<link rel="stylesheet" type="text/css" href="../../css/aui.css" />
		<link rel="stylesheet" type="text/css" href="../../css/font/iconfont.css" />
	</head>
	<body>
		<script type="text/javascript" src="../../script/AHelper.js"></script>
		<script type="text/javascript" src="../../script/zepto.min.js"></script>
		<script type="text/javascript">
			Zepto(function() {
			});
			// 监听来自func页面的事件
			function addEventListenerFromFunc(eventName, callback) {
				api.addEventListener({
					name : eventName
				}, function(ret) {
					if (ret && ret.value) {
						var obj = ret.value;
						if ( typeof callback == "function") {
							callback(obj);
						}
					}
				});
			}


			H.ready(function() {
				H.$showProgress();
				bMap = api.require('bMap');
				//1秒延时加载
				setTimeout(function() {
					//获取当前手机位置信息
					bMap.getLocation({
						accuracy : '10m',
						autoStop : true,
						filter : 1
					}, function(ret, err) {
						//如果获取成功则打开百度地图
						if (ret.status) {
							bMap.open({
								rect : {
									x : 0,
									y : 0,
									w : api.frameWidth,
									h : api.frameHeight
								},
								center : {
									lon : ret.lon,
									lat : ret.lat
								},
								zoomLevel : 18,
								showUserLocation : true,
								fixedOn : api.frameName,
								fixed : false
							}, function(ret) {
								if (ret.status) {
								}
							});
							H.$getPrefs(function(ret, err) {
								var retobj = eval('(' + ret.value + ')');
								H.$ajax(function(ret, err) {
									H.$hideProgress();
									//添加标注
									bMap.addAnnotations({
										annotations : ret.retValue,
										icon : 'widget://image/mark_red.png',
										draggable : false
									}, function(ret) {
										//H.$alert(ret);
										if (ret) {
											var id = ret.id;
											//获取当前的标注点经纬度
											bMap.getAnnotationCoords({
												id : ret.id
											}, function(ret) {
												if (ret) {
												
													//获取地址信息
													bMap.getNameFromCoords(ret, function(ret, err) {
														if (ret.status) {
															bMap.setBubble({
																id : id,
																bgImg : 'widget://image/map_bgp.png',
																content : {
																	title : '毛毛',
																	subTitle : ret.address + ret.streetName + ret.streetNumber,
																	illus : 'widget://image/map_pet.png'
																},
																styles : {
																	titleColor : '#fff',
																	titleSize : 14,
																	subTitleColor : '#999',
																	subTitleSize : 12,
																	illusAlign : 'right'
																}
															}, function(ret) {
																if (ret) {
																	alert(JSON.stringify(ret));
																}
															});
//															H.$alert("当前地址：" + ret.address + ret.streetName + ret.streetNumber);
														}
													});
												}
											})
										}
									});
									//用户设备定位API
								}, 'http://q.endzk.com/deviceapi/position/token/' + retobj.token);
							}, 'userinfo');
						} else {
							H.$toast("抱歉定位失败，原因：" + err.code);
						}
					});
				}, 1000);
			});
		</script>
	</body>
</html>