<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title></title>
		<link rel="stylesheet" type="text/css" href="../../css/aui.css" />
	</head>
	<body>
		<script type="text/javascript" src="../../script/AHelper.js"></script>
		<script type="text/javascript" src="../../script/zepto.min.js"></script>
		<script type="text/javascript">
			var retobj = null, bMap = null;
			Zepto(function($) {
			});
			// 监听来自func页面的事件
			function addEventListenerFromFunc(eventName, callback) {
				api.addEventListener({
					name : eventName
				}, function(ret) {
					if (ret && ret.value) {
						var obj = ret.value;
						if ( typeof callback == "function") {
							callback(obj);
						}
					}
				});
			}


			H.ready(function() {
				// 1.0 加载地图阻塞页面
				api.showProgress({
					title : '定位中'
				});
				// 1.1 获取用户信息
				H.$getPrefs(function(ret, err) {
					retobj = eval('(' + ret.value + ')');
					api.ajax({
						url : window.deviceserverUrl + '/position/token/' + retobj.token,
						cache : false,
						timeout : 10
					}, function(ret, err) {
						api.hideProgress();
						if (ret) {
							switch(parseInt(ret.retCode)) {
								case 1:
									//添加标注
									bMap.addAnnotations({
										annotations : ret.retValue,
										icon : 'widget://image/mark_red.png',
										draggable : false
									}, function(ret) {
										H.$toast(ret);
									});
									bMap.setBubble({
										id : 11,
										bgImg : 'widget://image/map_bgp.png',
										content : {
											title : '毛毛(2016年02月28日23:43:09)',
											subTitle : '河南省郑州市惠济区沙口路8号金沙国际号楼',
											illus : 'widget://image/map_pet.png'
										},
										styles : {
											titleColor : '#ffc000',
											titleSize : 13,
											subTitleColor : '#fff',
											subTitleSize : 12,
											illusAlign : 'left'
										}
									}, function(ret) {
										if (ret) {
											alert(JSON.stringify(ret));
										}
									});
									break;
								case 0:
									api.toast({
										msg : '宠物定位失败，请重试！'
									});
									break;
							}
						} else {
							api.toast({
								msg : '宠物定位失败，请重试！'
							});
						}
					});
				}, 'userinfo');
				bMap = api.require('bMap');
				//1秒延时加载
				setTimeout(function() {
					//获取当前手机位置信息
					bMap.getLocation({
						accuracy : '10m',
						autoStop : true,
						filter : 1
					}, function(ret, err) {
						//如果获取成功则打开百度地图
						if (ret.status) {
							api.openFrame({
								name : 'position_man_button',
								url : 'position_man_button.html',
								rect : {
									x : 10,
									y : api.frameHeight,
									w : 30,
									h : 30
								},
								bounces : false,
								vScrollBarEnabled : false,
								hScrollBarEnabled : false
							});
							api.openFrame({
								name : 'position_map_zoom_button',
								url : 'position_map_zoom_button.html',
								rect : {
									x : api.frameWidth - 40,
									y : api.frameHeight - 20,
									w : 30,
									h : 67
								},
								bounces : false,
								vScrollBarEnabled : false,
								hScrollBarEnabled : false
							});
							bMap.open({
								rect : {
									x : 0,
									y : 0,
									w : api.frameWidth,
									h : api.frameHeight
								},
								center : {
									lon : ret.lon,
									lat : ret.lat
								},
								zoomLevel : 18,
								showUserLocation : true,
								fixedOn : api.frameName,
								fixed : false
							}, function(ret) {
								if (ret.status) {
								}
							});
						} else {
							H.$toast("抱歉定位失败，原因：" + err.code);
						}
					});
				}, 1000);
				// 定位到当前位置
				addEventListenerFromFunc("position", function(ret) {
					//定位到当前位置逻辑
					bMap.showUserLocation({
						isShow : true,
						trackingMode : 'none'
					});
				});
				//地图放大
				addEventListenerFromFunc("position_zoom_out", function(ret) {
					bMap.zoomOut();
				});
				//地图缩小
				addEventListenerFromFunc("position_zoom_ln", function(ret) {
					bMap.zoomIn();
				});
				//定位到宠物位置
				addEventListenerFromFunc("positionPet", function(ret) {
					//定位到宠物位置逻辑
				});
				// 关闭地图
				addEventListenerFromFunc("map_close", function(ret) {
					bMap.close();
				});
			});
		</script>
	</body>
</html>